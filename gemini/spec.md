# 專案設計文件：開發流程自動化優化

## 專案概述
本專案旨在優化現有開發流程，解決資訊傳遞失真、溝通效率低、資料查找繁瑣及缺乏自動化提醒的痛點。透過 **n8n**、**Discord Bot** 和 **LLM** 技術，實現 BUG 單自動化、專案資訊查詢及專案版控表記錄，提升效率並減少人為錯誤。

---

## 背景與痛點
### 現有問題
1. **資訊傳遞失真與耗時**：客戶 BUG 單經業務、PM 傳遞至開發人員，經過三手導致資訊失真，且來回詢問耗時。
2. **溝通效率低**：使用 LINE 作為主要溝通工具，無分頻道，查找訊息困難，無自動提醒。
3. **資料查找繁瑣**：開發者需手動查詢 Google Sheet 獲取專案資訊（如帳密、資料庫連線），專案多時效率低下。
4. **未完成需求無提醒**：未完成 BUG 單需手動查詢公司網站，網站效能差且難用。

### 專案目標
1. 自動化 BUG 單提交與通知流程，減少人為傳遞。
2. 透過 Discord Bot 快速查詢專案資訊與未完成 BUG 單。
3. 自動化專案版控表記錄，提升版本管理效率。
4. 提高資訊透明度與溝通效率，確保資料結構化與安全。

---
## 作業流程
1. 討論實作細節
2. 修改樣板風格遵照現有TS跟LINT設定
2. 建立整合測試
3. 開始實作

---

## 技術架構
### 使用工具
- **n8n**：工作流自動化，處理 Webhook、Google Sheet 寫入、AI 整合及 Discord 通知。
- **Discord Bot**：提供指令介面，查詢資料及提交版控資訊。
- **Google Sheet**：集中儲存 BUG 單與版控資訊。
- **AI**：整理表單資料、生成回覆、處理查詢結果（使用 Grok 或其他 LLM）。
- **公司資料庫**：儲存專案資訊與需求單，透過 n8n 查詢。

### 系統架構圖
```plaintext
客戶/業務(分兩種) -> n8n Webhook 表單 -> Google Sheet (紀錄表單內容) -> AI 整理 -> 自動回信客戶，寄信提提醒開發人員 -> Discord 通知
開發者 -> Discord Bot -> n8n Webhook -> 公司 Google Sheet 爬蟲 -> AI 整理 -> Discord 回傳
開發者 -> Discord Bot -> n8n Webhook -> Request 公司資料庫 -> AI 整理 -> Discord 回傳
開發者 -> Discord Bot (/version) -> Prompt(進版訊息) -> n8n Webhook -> Google Sheet (VersionControl) -> Discord 確認
```

---

## 功能模組與實施步驟
以下為三個主要功能模組的詳細設計與實施步驟，包含 Discord Bot 指令需求及需串接 LLM 的步驟。

### 模組 1：BUG 單表單自動化
**目標**：業務或客戶提交 BUG 單，自動記錄至 Google Sheet，AI 整理後回覆客戶並通知 Discord。

#### 實施步驟
1. **設計 n8n Webhook 表單**：
   - **內容**：建立公開表單 URL，包含欄位：
     - 客戶名稱（必填，文本）
     - 客戶聯絡人（必填，文本）
     - 客戶聯絡信箱（必填，文本）
     - 專案名稱/系統名稱（必填，文本）
     - 問題簡述（必填，長文本）
     - 問題詳述（必填，長文本）
     - 使用者登入帳號（選填）
     - 發生時間（必填，日期）
     - 預期完成時間（選填，日期）
     - 使用平台（選填）
     - 瀏覽器版本（選填）
     - 作業系統與版本（選填）
     - 是否可重現（必填）
     - 備註（選填）
     - 嚴重性（選項：無法使用、功能受限...）
     - 附加截圖（選填，可複選）
   - **細節**：啟用資料驗證，生成唯一 Ticket ID（使用 n8n `$now` 或 UUID）。
   - **工具**：n8n Webhook 節點。

2. **記錄至 Google Sheet**：
   - **內容**：將表單資料寫入 `Bugs` 工作表。
   - **欄位**：
     - Ticket ID
     - 提交時間（自動生成）
     - 客戶 ID
     - 專案名稱
     - BUG 描述
     - 問題類型
     - 嚴重性
     - 狀態（預設 `Open`）
     - 問題摘要（AI 生成）
   - **細節**：使用 n8n Google Sheets 節點，確保 OAuth2 授權。
   - **工具**：n8n Google Sheets 節點。

3. **AI 整理與回覆**：
   - **內容**：將 BUG 描述送至 AI，生成問題摘要並製作客戶回覆模板。
   - **提示詞範例**：`將以下 BUG 描述整理為簡潔摘要，包含問題類型和嚴重性，並生成專業回覆信件：{BUG 描述}`
   - **輸出**：
     - 摘要存入 Google Sheet（`問題摘要` 欄位）。
     - 回覆信件透過 n8n Email 節點發送。
   - **細節**：使用 Grok 或其他 LLM 處理。
   - **工具**：n8n AI 節點（Grok 或 OpenAI）。
   - **需串接 LLM**：是。

4. **Discord 通知**：
   - **內容**：推送表單提交資訊至 `#bug-tickets` 頻道。
   - **訊息格式**：Embed 訊息，包含：
     - Ticket ID
     - 客戶 ID
     - 專案名稱
     - 問題摘要
     - 嚴重性
     - 動態標籤（如 `@Developer`）
   - **細節**：高嚴重性 BUG 啟用額外 @mention。
   - **工具**：n8n Discord 節點。

### 模組 2：Discord Bot 查詢
**目標**：開發者透過 Discord Bot 查詢公司資料庫的專案資訊與未完成 BUG 單。

#### Discord Bot 指令需求
- **指令**：
  - `/project <客戶ID>`：查詢GOOGLE SHEET專案資訊（如帳密、資料庫連線名稱）。
    - **參數**：Project Name（必填，文本）。
    - **輸出**：專案相關資訊（帳號、密碼前4位、資料庫連線等）。
    - **權限**：僅限 `@Developer` 角色。
  - `/bugs <狀態>`：列出指定狀態的 BUG 單（`Open` 或 `Pending`）。
    - **參數**：狀態（選填，預設列出 `Open` 和 `Pending`）、承辦人(選填，列舉伺服器開發人員)。
    - **輸出**：BUG 單清單（Ticket ID、專案名稱、問題摘要、提交時間）。
    - **權限**：僅限 `@Developer` 和 `@PM` 角色。
  - `/chat`: 詢問 LLM，並且要限制詢問的問題跟頻率
    - **參數**: 問題描述
    - **輸出**: LLM 回應的 md 格式
    - **權限**: 僅限 `@Developer` 和 `@PM` 角色。
  - `/work-on`
    - **功能**: 上班打卡，並記錄今日預計處理事項。
    - **參數**: `今日工作` (必填, 文本): 預計今日要處理的工作項目。
    - **權限**: `@Developer`
  - `/work-off`
    - **功能**: 下班打卡，並回報今日完成進度。
    - **參數**: `完成進度` (必填, 文本): 今日工作的完成進度回報。
    - **權限**: `@Developer`
- **細節**：指令需驗證參數格式，敏感資料（如密碼）需遮罩。

#### 未來可擴充指令建議

*   **/version**
    *   **功能**: 快速查詢指定專案的最新版本號及更新內容。
    *   **參數**:
        *   `專案ID` (必填, 文本): 要查詢的專案 ID 或名稱。
    *   **權限**: `@Developer`

*   **/release-notes**
    *   **功能**: 自動生成指定版本的發布說明 (Release Notes)。
    *   **參數**:
        *   `專案ID` (必填, 文本): 專案的 ID 或名稱。
        *   `版本號` (必填, 文本): 要生成說明的版本號。
    *   **權限**: `@Developer`, `@PM`

*   **/assign-bug**
    *   **功能**: 將 BUG 指派給特定開發者。
    *   **參數**:
        *   `TicketID` (必填, 文本): BUG 的 Ticket ID。
        *   `使用者` (必填, 使用者): 要指派的 Discord 使用者。
    *   **權限**: `@PM`

*   **/update-bug-status**
    *   **功能**: 快速更新 BUG 的狀態。
    *   **參數**:
        *   `TicketID` (必填, 文本): BUG 的 Ticket ID。
        *   `狀態` (必填, 選項): 新的狀態，例如 `處理中`, `待測試`, `已解決`。
    *   **權限**: `@Developer`, `@PM`

*   **/my-tasks**
    *   **功能**: 列出所有指派給自己的待辦 BUG 單。
    *   **參數**: 無。
    *   **權限**: `@Developer`

*   **/whois**
    *   **功能**: 查詢專案的負責人與核心開發者。
    *   **參數**:
        *   `專案名稱` (必填, 文本): 要查詢的專案名稱。
    *   **權限**: 全員

*   **/remind-me**
    *   **功能**: 設定個人化提醒。
    *   **參數**:
        *   `時間` (必填, 文本): 提醒的時間，例如 `2 hours`, `明天上午10點`。
        *   `訊息` (必填, 文本): 提醒的內容。
    *   **權限**: 全員

*   **/poll**
    *   **功能**: 快速發起一個投票。
    *   **參數**:
        *   `問題` (必填, 文本): 投票的主題。
        *   `選項1` (必填, 文本): 投票的選項一。
        *   `選項2` (必填, 文本): 投票的選項二。
        *   `(更多選項)` (選填, 文本): 其他投票選項。
    *   **權限**: 全員

#### 實施步驟
1. **開發 Discord Bot**：
   - **內容**：使用 Discord.js 或 discord.py 實現指令處理。
   - **細節**：在 Discord 開發者門戶創建 Bot，設定 Token 與權限。
   - **工具**：Discord.js 或 discord.py。

2. **n8n 接收 Webhook**：
   - **內容**：接收 Bot 發送的指令請求（如 `/project 12345`）。
   - **細節**：確保 Webhook URL 安全（使用認證）。
   - **工具**：n8n Webhook 節點。

3. **查詢公司資料庫**：
   - **內容**：透過 n8n HTTP Request 或 Database 節點查詢：
     - 專案資訊：客戶 ID → 帳密、資料庫連線。
     - 未完成 BUG 單：狀態為 `Open` 或 `Pending`。
   - **細節**：使用環境變數儲存資料庫憑證。
   - **工具**：n8n HTTP Request 或 Database 節點。

4. **AI 處理結果**：
   - **內容**：整理查詢結果為易讀格式，隱藏敏感資料。
   - **提示詞範例**：`將以下專案資訊整理為簡潔清單，隱藏敏感資料（如密碼僅顯示前4位）：{查詢結果}`
   - **工具**：n8n AI 節點。
   - **需串接 LLM**：是。

5. **回傳至 Discord**：
   - **內容**：將整理後結果以 Embed 格式回傳至指定頻道或私訊。
   - **細節**：包含時間戳與查詢者標籤。
   - **工具**：n8n Discord 節點。

### 模組 3：專案版控表自動化
**目標**：透過 Discord Bot 提交專案版控資訊，n8n 記錄至 Google Sheet。

#### Discord Bot 指令需求
- **指令**：
  - `/push-version <專案ID> <版本號> <更新內容> <狀態>`：
    - **參數**：
      - 專案 ID（必填，文本）。
      - 版本號（必填，如 v1.0.1，需符合語義化版本規範）。
      - 更新內容（必填，markdown 長文本）。
      - 狀態（必填，選項：開發中、測試中、已上線）。
    - **輸出**：確認訊息（如 `版本 v1.0.1 已記錄至專案 PROJ123`）。
    - **權限**：僅限 `@Developer` 角色。
- **細節**：驗證版本號格式與專案 ID 存在性。

#### 實施步驟
1. **設計 Google Sheet 版控表**：
   - **內容**：建立 `VersionControl` 工作表，包含欄位：
     - 專案 ID
     - 版本號
     - 更新內容
     - 提交者（從 Discord 使用者取得）
     - 提交時間（自動生成）
     - 狀態
   - **細節**：設定 Sheet 權限（n8n 寫入，團隊唯讀）。
   - **工具**：Google Sheet。

2. **開發 Discord Bot 指令**：
   - **內容**：實現 `/version` 指令，驗證參數並發送至 n8n。
   - **細節**：限制指令給 `@Developer` 角色。
   - **工具**：Discord.js 或 discord.py。

3. **n8n 接收指令**：
   - **內容**：接收 Bot 發送的版控資訊。
   - **細節**：驗證 Webhook 請求來源。
   - **工具**：n8n Webhook 節點。

4. **記錄至 Google Sheet**：
   - **內容**：將版控資訊寫入 `VersionControl` 工作表。
   - **欄位映射**：
     - 專案 ID → 專案 ID
     - 版本號 → 版本號
     - 更新內容 → 更新內容
     - 提交者 → Discord 使用者
     - 提交時間 → `$now`
     - 狀態 → 狀態
   - **細節**：若專案 ID 不存在，發送錯誤通知。
   - **工具**：n8n Google Sheets 節點。

5. **Discord 確認通知**：
   - **內容**：寫入成功後回傳確認訊息，失敗時推送錯誤訊息。
   - **工具**：n8n Discord 節點。

### 模組 4：其他優化與維護
1. **Discord 頻道結構**：
   - **內容**：
     - `#bug-tickets`：新 BUG 單通知。
     - `#version-control`：版控更新通知。
     - `#dev-tasks`：查詢結果與未完成 BUG 提醒。
   - **細節**：使用 Thread 追蹤單一 BUG 或版本討論。

2. **資料安全**：
   - **內容**：
     - 敏感資料（如帳密）僅限 `@Developer` 查詢。
     - Google Sheet 設定唯讀權限，n8n 獨立寫入。
     - n8n 使用環境變數儲存 API 密鑰與資料庫憑證。
     - **API 安全**：所有從 Discord Bot 發送到 n8n Webhook 的請求，都必須在請求的 Header 中攜帶一個由伺服器端生成的 JWT (JSON Web Token)。n8n 端會驗證此 Token 的有效性，無效或缺失 Token 的請求將被拒絕。
   - **工具**：Google Sheet 權限管理、n8n 環境變數、`jsonwebtoken` 套件、n8n JWT 驗證節點。

3. **日誌與監控**：
   - **內容**：記錄 n8n 工作流執行日誌（Webhook、AI、Sheet 寫入）。
   - **細節**：失敗時推送錯誤至 `#system-alerts` 頻道。
   - **工具**：n8n 日誌功能。

4. **測試與部署**：
   - **內容**：測試案例：
     - 提交 BUG 單並驗證 Sheet 記錄與 Discord 通知。
     - 使用 `/project` 和 `/bugs` 查詢資料。
     - 提交版控資訊並確認 Sheet 更新。
   - **細節**：模擬高負載情境，檢查效能。
   - **工具**：n8n 測試模式、Discord 測試伺服器。

5. **自動化打卡與提醒系統**：
   - **內容**：
     - **打卡服務**：建立 `AttendanceService` 來處理開發者的打卡 (`/work-on`) 與下班 (`/work-off`) 狀態，所有紀錄皆存於記憶體中。
     - **排程工作**：使用 `node-schedule` 建立三個自動化排程工作：
       - **每日重置** (`ClearAttendanceJob`)：於每日午夜自動清除所有打卡紀錄。
       - **午間提醒** (`NoonReminderJob`)：於平日中午 12 點，對尚未打卡的開發者在指定頻道發送提醒。
       - **傍晚提醒** (`EveningReminderJob`)：於平日傍晚 5 點，對尚未下班的開發者在指定頻道發送提醒。
   - **細節**：所有排程工作的時間、啟用狀態、提醒頻道 ID 皆可在 `config.json` 中進行設定，無需修改程式碼。


---

## 需要串接 LLM 的步驟
1. **模組 1 - BUG 單表單自動化**：
   - **步驟 3：AI 整理與回覆**：
     - 功能：整理 BUG 描述為摘要，生成客戶回覆信件。
     - LLM 需求：Grok 或其他 LLM，處理自然語言生成。
     - 提示詞範例：`將以下 BUG 描述整理為簡潔摘要，包含問題類型和嚴重性，並生成專業回覆信件：{BUG 描述}`

2. **模組 2 - Discord Bot 查詢**：
   - **步驟 4：AI 處理結果**：
     - 功能：整理資料庫查詢結果為易讀格式，隱藏敏感資料。
     - LLM 需求：Grok 或其他 LLM，處理資料格式化與遮罩。
     - 提示詞範例：`將以下專案資訊整理為簡潔清單，隱藏敏感資料（如密碼僅顯示前4位）：{查詢結果}`

---

## 附件
- **Google Sheet 範本**：`Bugs` 與 `VersionControl` 工作表結構。
- **n8n 工作流範例**：表單處理、查詢、版控記錄。
- **Discord Bot 指令清單**：`/project`、`/bugs`、`/version`。
- **AI 提示詞範例**：BUG 摘要、客戶回覆、查詢結果整理。

